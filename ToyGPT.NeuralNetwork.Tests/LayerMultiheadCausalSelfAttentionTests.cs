using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using NUnit.Framework;
using ToyGPT.NeuralNetwork.Layers;

namespace ToyGPT.NeuralNetwork.Tests;

internal class LayerMultiheadCausalSelfAttentionTests
{
	[Test]
	public void ForwardTest1()
	{
		var x = new float[,]
		{
			{ -1.050335222934455f, -0.16188000417985582f, -2.110723092143606f, -0.31058619614164595f, -1.248243574408124f, 0.25718152332744215f, -0.5710898976010113f, -2.1512244835872383f, -0.028805263771172405f, 1.392375431583876f, -1.0625751970236532f, 0.5780070644973011f, },
			{ 0.7494495319151824f, 1.2114251049290614f, -0.3987547187413757f, 0.13027044693638842f, -1.2934870508174467f, -0.2514157574409321f, 0.7649046785536526f, -1.1531040759237303f, -0.38920245431361894f, 0.06232209654278288f, -0.2208261725627074f, -0.5115882547300495f, },
			{ 1.4955294571767894f, 0.9127829300871543f, 0.4705336406796267f, -0.5560527569138081f, -0.9331185944242767f, -0.6474827816381284f, -1.1216275584120519f, 0.33819451557425617f, -0.09270532053937096f, -0.4816591715352301f, -0.912627395792325f, 0.475480861356776f, }
		};
		var attnW = new float[,]
		{
			{ 1.17797548310881f, 0.7377249869084599f, -0.0801539993235059f, -2.004895384736359f, 1.1081736180051203f, -0.02696160232917344f, -0.6610847781554602f, -0.2566813054143782f, 1.0792106870505327f, -0.4039521321520195f, 0.05313671675553097f, -1.1175808176418496f, -0.352125802116473f, 0.5914835707915992f, 0.9840092951968593f, -0.022803439100731595f, -0.10072066578052583f, -0.815561711818516f, -0.11221542901848992f, -1.0702001860277377f, -2.172160176632872f, 0.4091292853675123f, -0.7973642409831648f, -0.45997600120855636f, 0.6279723811915277f, 1.4875120675389613f, -0.643508127784911f, -0.9315250108859522f, 0.3491873937503941f, -1.1116792954398564f, 0.5436331444747938f, 0.4234821045146395f, 1.7337618891458013f, 2.1957965666217016f, -0.40760432205375086f, -1.7094968184489245f, },
			{ 0.2848915869731635f, 0.5054135744540936f, -0.7844289698610581f, 0.15386917174635326f, 1.0283544798690358f, 0.6643847804598995f, -0.0035898714460456367f, -0.3372896776375347f, 2.0056444562268796f, -1.1711080896262909f, -0.5836306219304116f, -1.0911292922252567f, 1.856330731781684f, 1.8688467154499642f, 0.35317173693395937f, 1.3116854598043906f, 0.367940817547532f, -0.45760029026953647f, -0.7941383283115645f, 0.1647883405401558f, 0.2327421742433454f, -2.458651177511093f, 0.5609061142666203f, -0.36151780950276846f, -0.5468621361505226f, 0.5665077639868883f, -1.2279378005890411f, 0.9000822389026588f, 0.13503635288334384f, -0.5924927009235299f, 0.2811369906305489f, -2.2123277614936456f, -2.530065675344614f, -0.8488206665170147f, -0.5310325943402666f, -0.3018244469894917f, },
			{ -0.32974556784331893f, -0.3294097777578706f, 0.10404807510752169f, -1.311430146606126f, -1.4190772291298688f, 0.6887878082162564f, -0.997076236537989f, -1.5917971791016594f, 0.9982955639982934f, -0.6603362019169943f, -0.7091893544754524f, 1.0001605320652065f, 0.41593023108973687f, -0.2701383206534217f, 0.25014925267212346f, -0.875755312130093f, 0.22296009554583546f, 0.035606792731426314f, 0.7807443054529694f, -1.2369107692079018f, -0.1971709563435307f, 1.7359553105662757f, 0.026483214753781743f, -0.04543054828107211f, -1.1274750133530935f, -1.5563126870694102f, 1.0500682357199107f, -1.3415974988310422f, -2.394934745071738f, 0.7868440232876894f, -0.9686178759741991f, -0.37372316296911406f, 1.248848960255837f, 0.032310337395908384f, 0.47471417968658747f, 0.4912363505881091f, },
			{ 0.4067868692520198f, 0.39803467382796087f, -1.356734447958629f, 0.3336702664640327f, -0.8145775790464274f, 0.10959481899896575f, 0.8425391590751184f, -0.338312473126689f, 0.5185103204384561f, -1.3533431580261241f, 0.5431766316640033f, 1.847179297486698f, 0.8173168288237219f, 0.2710557952069423f, -0.4945553334822229f, -0.5643109835886474f, 0.2816807632941316f, 1.0874075475171525f, -1.7142919782349015f, 1.4347541572194027f, 1.13018062942084f, 0.8392260102248157f, 0.5065093593095923f, -1.5493906335705219f, -0.5493082485419357f, 0.9897127060259957f, -0.21496258033706134f, 0.6497972598000841f, 1.1853274198307888f, 0.3578158230928776f, -2.847410177004278f, 2.0577307447171775f, 0.5080682445743285f, 0.5510178883614171f, 1.0360406746050197f, 0.6328609345315536f, },
			{ 0.4608308958697653f, -0.04606755166126241f, 0.8806792005109383f, 1.3349588544116802f, 0.4076631013030366f, -0.29358302526488933f, -0.6470031335069585f, 0.6269297377210804f, 0.2944045622406934f, 0.35244000499260353f, 2.5774651287402564f, 0.34982543431081436f, -0.0896230220855575f, -0.06612532869961547f, -0.32110494471136614f, -0.30444942667728636f, 0.4140464565403021f, 1.2488660992899783f, -1.8040584060021012f, 0.04716214670564958f, 0.10291313471540427f, 2.3011679177722693f, 0.588930314290046f, -0.649434283971301f, -0.811652410756146f, -0.03221040379526566f, -0.3939533069618786f, -0.8346340282854893f, 1.300026537136799f, 1.309073719082387f, 0.2321680877791451f, -0.29271724590880405f, -1.4352400654588457f, -1.3481342698838845f, -2.1148271458651955f, -1.2504759111049895f, },
			{ 1.2234630840631324f, 1.780470317422786f, -0.080896817484694f, -0.9048515819803917f, 0.5790246743644611f, -0.5520739478072192f, 0.8256940906016486f, 0.667190146961404f, -1.2015056902507235f, -1.4164278895500277f, -0.5645055619854454f, 1.5973815723412041f, 0.5916896380269256f, -1.8634398757059072f, 2.0431430370563466f, -0.8317728386776854f, -0.39220453724450083f, -0.2988141774231249f, -1.183681595508262f, -0.10849422731710216f, -0.635927866809067f, -1.4470806071269455f, 0.9702970533693375f, -0.02698132622440617f, 0.48884165056718587f, 0.6049127670699902f, 0.4717424978229412f, -0.6413660685667051f, 0.7078631452151384f, 1.8931718261493549f, 0.3223917990571986f, -0.5493673104667056f, 0.005334476475772939f, -1.780925541571951f, -1.523333366973425f, 0.5636805979140438f, },
			{ -0.013621493280714589f, -1.7645837734438f, -1.1095081269191316f, 2.0776410012599333f, -0.09022262330245297f, 0.3028895532076746f, 0.4429791975765612f, -1.4101636460505798f, -0.14052109413197464f, -0.4581251890655083f, -0.5981516903140858f, 0.8063061443164657f, -0.856167762319465f, -0.1765945929631652f, -0.1857331870552163f, 0.930754897359729f, -0.3890970101215289f, 0.3120032015393137f, 0.8346554810618194f, -1.2914250667872114f, -0.3557884381071879f, -0.8021390172520289f, -0.5640331134922982f, 0.920542525131171f, -0.6525386690136802f, 0.08017003662983939f, -1.072840788152814f, -0.2544406337473984f, -0.05169338812862246f, -0.28342282244831374f, 0.5125422715620197f, -0.3289179315582173f, -0.23318379149204904f, -1.2005314020219642f, -0.8987813171282453f, -0.6209074069067438f, },
			{ 0.3590900799665592f, 0.17892321939315006f, 1.0412594309436718f, 1.2250460180081961f, 0.38225300942723467f, 0.7677702854766902f, 0.30113453383920835f, -0.6674831083342061f, -0.23954640322072654f, 0.21470141869517723f, 0.2576179483511225f, -0.6653370000769031f, -0.9005619889993431f, 0.29938778967263374f, -0.8130759131581841f, -0.047060254551601406f, -0.6570419716437262f, 0.7496155531953217f, -0.09240844912730573f, -0.7892355151473733f, -1.4274223147339864f, 1.0497777795567813f, -1.8388663486284287f, 1.7848812218590406f, 0.6109536170727192f, 1.4007032303998277f, -1.6608769605044726f, 0.0005516853587775899f, -0.8074246630042354f, -0.47950512470849077f, -1.0917570283324625f, 0.13881682226821573f, -0.313282650650784f, 0.6464673205361126f, -0.2414838200406783f, 0.18535769624789153f, },
			{ 0.44080983670993434f, -0.47112754147023056f, 0.6750670509658994f, 0.5264841745767357f, 1.0645743497202265f, 0.21573707847221113f, -0.5111798632497465f, -0.6689916626110002f, -1.4636527147306846f, 0.956029963169993f, 0.36912476460261445f, -1.2570340927935761f, -1.407128443796386f, -0.5871283908619044f, 0.7481786673511915f, -1.0375024334339629f, -0.27272991844210814f, -0.2848678592145481f, 2.1971063759303067f, -0.4650140476098692f, 1.2961637423122596f, 0.3520619188261571f, 0.7529860270050122f, 1.2097607704326268f, 1.119808812178205f, -0.49502867840186704f, -0.6595305812914117f, -2.138915766087097f, 0.3129149520313163f, 0.37938507744970373f, -0.7851114516903921f, -0.5029504073410305f, 0.6639874343379101f, -0.7225407114524539f, 0.19235989496890954f, -1.2272404776136328f, },
			{ -1.1047371645206279f, 1.1373452397909931f, 0.9242174457952185f, 1.0090593913189077f, -0.11165596066100705f, -0.7078919170895887f, 0.21527880956414755f, 0.06317361086387646f, -0.2954181984087754f, -0.9930710614576584f, 0.14600337392580306f, -1.273013586504588f, 0.3470789893253157f, -0.39059367790215377f, -1.2050725201849117f, -0.013277153595579641f, -2.2893365883521497f, -0.4961143822821992f, -0.22554251740613557f, -0.33874938592782283f, 0.5555662080572042f, 1.2459415601610866f, 1.1720081433213598f, 1.2297486733699272f, 1.2327950789691258f, -0.3387093868851081f, 0.2668655516953854f, -1.6291289425513438f, -2.5284489211910306f, -1.8604267559885954f, 0.5883450210308607f, -0.14660092083505682f, -2.2726380774771746f, 0.27522829646835284f, -0.6896684797784018f, -1.710002506759833f, },
			{ 2.884230255168133f, 0.35383392967234056f, 1.7434386589001905f, -0.5686569972554386f, -0.06838978055103132f, 1.1174049095486798f, 0.9725435808129753f, 0.051675773366568624f, 0.33331697609825206f, 0.4874666838178126f, -1.5194775764566435f, 2.874667209058916f, 1.4163388480033936f, 1.208323768865626f, -1.9163064029360237f, -0.33553251906477627f, 1.3987639251294743f, -1.7309613154201233f, 0.03005509771176024f, 0.07513082650537474f, 0.9082631492234413f, -0.7565419614644747f, -0.8873001738726412f, -0.45430872132769484f, 1.1043540184268292f, 0.1901583621745097f, 1.9799118193091862f, -0.38532495339429795f, 0.8988899458596923f, -2.1749311592463614f, -0.7771920923096258f, -0.12126411827019017f, 0.6222104322478148f, -1.249639565866601f, 0.9886777910294553f, 0.6474914900000439f, },
			{ 0.02656945910955646f, -0.6950414114529154f, 0.2759265549482963f, 0.013551742574585246f, -0.25173122290364297f, -0.7161291438936698f, -0.5051606899969028f, 0.2554040776888711f, 0.4015219802340924f, -0.32935782661366153f, -0.7828265434546933f, -0.5243426514100233f, -0.7617770941640193f, -0.8760853373171309f, -0.7819999598144471f, -0.3047402460832433f, 0.8964832889233392f, 0.17070008327083072f, -0.19549111480964965f, -1.0553614221477303f, -1.2864121975303362f, 0.49819298493044595f, 0.4826706955800781f, -0.7475570455064023f, 1.776116848717281f, -0.9285651939265467f, -1.044133288885011f, -0.13585812160682756f, 0.2922392044017332f, 0.9731218678197942f, -0.15435609442272974f, 0.7311724980406006f, -0.21689160037026975f, 0.05263525779848974f, 0.6822425587040604f, 0.745232269766377f, }
		};
		var attnB = new float[]
		{
			-0.20498290930934018f, -0.8499346884260642f, 1.30771296066278f, -2.038752957896151f, 1.4802535093871785f, -0.28717585462342454f, 0.48761497814606525f, -0.17246817408794887f, 0.6665512626484721f, -0.5053435073541315f, -0.5189734558383089f, 2.6132828094878766f, 0.5171999285066659f, 0.6858352448599484f, 0.2484133671465388f, 1.2230816815834815f, -0.6279460103763734f, -0.354362249682205f, 1.4951479424080243f, -1.6323962711416027f, -0.1274947265976598f, -1.1230134719126517f, -1.280012624310038f, 0.7265601738238682f, -0.2989236892453901f, -1.0511750375169147f, -0.4164334471425662f, 0.349898621470596f, 0.7734235233335521f, -0.3607115725682522f, -2.0335970233678227f, 2.2515787232846636f, 1.068124741264783f, -0.7871152263337159f, 0.41753663342638325f, -0.48170984205465733f,
		};
		var projW = new float[,]
		{
			{ -1.2961105744892787f, 1.8587053548475698f, 0.8207390744119711f, 0.7695137616572294f, 0.5496825590281164f, 0.5901851441061083f, -0.8736798152543797f, 0.22281620301553098f, -0.6196457229687045f, -0.6454034496253634f, -2.024513905102856f, -0.10747678196108403f, },
			{ 1.430443106853516f, -0.4844434815925774f, 0.6960382698859298f, 0.9749717303888155f, -0.30065947119612746f, -1.1810101791788505f, 0.7833642010406316f, 0.603609052982001f, 0.4821569882695708f, -2.5764577762931005f, 0.6000011285349506f, -0.1301329145081282f, },
			{ 0.5372944583798658f, -0.6462880047999796f, 0.22052626554163696f, 0.7554848899588561f, -0.625931237473994f, -0.6247281860427903f, 0.9808830485947403f, -0.046584211575897136f, 1.9820840128089994f, 0.8953599348597853f, 0.6459057799781753f, -0.08709725309499614f, },
			{ -0.41930032087577174f, 0.7299331594831424f, -0.014984198173852485f, 1.5827016432055734f, -1.830898801189644f, 0.4312941487623167f, 1.2181045187994703f, 0.9495815416671503f, -0.2033301383032336f, -0.7366041159735278f, -0.9499711852099638f, -0.06860718487690526f, },
			{ 0.1213160604805179f, 1.2557355853560244f, -1.0268044357917725f, 0.9416042138447261f, -0.40144976666051024f, -0.3901132720363062f, -1.154425987729265f, -2.8917134609458577f, -0.7706537113417085f, -0.2050297227292193f, -0.21248094085155889f, -0.5067359710142914f, },
			{ 1.2335935755167597f, 0.3109027893973812f, -0.7113141222471162f, -0.41261192082814324f, -0.7484141784800814f, -0.9373829637467999f, -0.5986643139163674f, 0.11774031092551367f, -0.497709752266679f, -0.8858961848013169f, 0.33424357675013217f, -1.7405024707627448f, },
			{ 0.8229978740815165f, 1.090658316098135f, -0.12503345086148598f, -1.3288663032538377f, 0.222224322561134f, 0.9158954979747058f, 1.5856347075377968f, -0.28566586651993986f, 0.5673339160952668f, -0.6262686594973819f, 1.3840480331090115f, -0.7306686264200914f, },
			{ 0.3509178676100206f, 1.0557332289069923f, 0.7674037439428258f, 1.18507927914708f, 1.6328993260096523f, 0.06744995770205033f, 1.675169975833752f, -0.6166310163755422f, 1.1725344774278992f, -0.48680163073427996f, -1.6382848773018193f, -1.4351459394877064f, },
			{ 0.4632960526032318f, -1.509246408752242f, -0.5697797210028537f, 0.5405593513616151f, 0.36032353397076794f, 1.9173826579502442f, -0.7162612522493577f, 0.05031925510589155f, -0.02895702448061161f, 0.7584554920754453f, 0.018020831028220146f, 1.3217917541121107f, },
			{ -0.8759092166933893f, 2.2481536373169324f, 0.9780677733806922f, 0.13885249364866808f, -0.18567093125980866f, -0.009448619941519505f, -0.5496400969391193f, -1.9143775085466272f, -0.22968352678445708f, 0.46006356851408203f, 0.3306326947239099f, 1.1316789147107889f, },
			{ 2.1805098924131396f, -0.05833098020378918f, -0.504271100553846f, -0.9037561852834766f, -0.4818832463004938f, 0.3075116344703248f, 2.0916080753970063f, 0.3701805352232365f, 0.2352439534654131f, -1.2382870221466828f, -0.9784529108011922f, 0.29290177328210554f, },
			{ 0.18294107325620262f, -1.5258095413484305f, 0.5716365641128083f, 0.45134080734711957f, 0.3508632361822093f, 0.4477051415647627f, 0.3308125661158263f, -1.064572761259629f, 2.128413218211563f, 0.707125454560966f, -0.3326429518280745f, 1.2223906164887737f, }
		};
		var projB = new float[]
		{
			-0.43217310558595673f, -0.4110626665970744f, -0.9735708276964584f, -0.11196872402596164f, 0.7534540578202631f, 2.331274056532559f, 0.05140269280101185f, -0.4064410046283944f, 1.4839158271990929f, -1.3978504569410442f, -0.8062371375855307f, 0.5060618630735992f,
		};
		var expected = new float[,]
		{
			{ -6.2846950550929215f, 23.507468768876244f, 0.8537786178049486f, -0.34545846484164056f, 0.8665042641624063f, 4.670827230157946f, 14.221323621524196f, -2.276484355154269f, 2.231861786898077f, -4.709794418001642f, -13.498736857124044f, -13.553813198492938f, },
			{ -13.496841156567985f, 13.706178440402514f, 0.78623506304274f, 4.420305045306469f, 0.0649189744594092f, 14.541249719044576f, 3.1935811585719893f, -1.6289108438729891f, -2.5924515479571353f, 5.732837073267336f, -14.0125271674389f, 6.85072313236457f, },
			{ -4.624573626895081f, 7.49471273478385f, 2.4272954039638472f, -2.032948630354459f, 1.6950706449915265f, 0.6900243186063437f, 6.699260745718954f, 7.0612322094000355f, -4.751689557717226f, -9.23133580507616f, -9.574161269074008f, -2.518492832670728f, }
		};
	}
}
