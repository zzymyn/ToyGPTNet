using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using NUnit.Framework;
using ToyGPT.NeuralNetwork.Layers;

namespace ToyGPT.NeuralNetwork.Tests;

internal class LayerCausalSelfAttentionTests
{
	[Test]
	public void ForwardTest1()
	{
		var q = new float[,]
		{
			{ 0.6603610614329992f, -1.539670718891173f, -1.38598199859325f, -2.5805078447252727f, 1.4500356053220609f, },
			{ 0.31811781931852623f, -0.2768040661173377f, 1.0570648945221115f, -0.09232438468715773f, -0.1312317474150476f, },
			{ 0.5509632382789439f, -1.4356220745992931f, -0.8035358907227391f, -0.2626081725349466f, -0.8090062711052147f, },
			{ -0.3322531910608613f, -0.30998992987560897f, -0.6179383369011086f, 0.1566710087563864f, -2.2465921774302924f, },
			{ -0.2267223181188867f, -0.9370794196439621f, 1.1572072531477242f, -0.4455463052748552f, 0.2774745584837395f }
		};

		var k = new float[,]
		{
			{ -0.17678519737722112f, -0.3239590831652442f, 0.740495126417451f, -0.7422145251038657f, 0.18997191464999014f, },
			{ -0.19179402932638223f, -0.04425149537403927f, -1.1536248806116653f, 0.9567603725523409f, 0.6791066596440402f, },
			{ -0.21993164870845322f, 0.1777332552171479f, 1.7060980051205625f, 1.0279078585058252f, -0.33819831937167294f, },
			{ -1.6520902207398336f, -0.9611628831503088f, 0.6870815844798491f, -1.795696925497907f, -2.3766297673086796f, },
			{ -0.3743811591853894f, -0.48165829274535965f, 0.035624992816219996f, 1.3304012445977504f, -0.8569078219252892f, }
		};

		var v = new float[,]
		{
			{ 1.6459018855506056f, -1.9031435435608153f, -1.4319935618416773f, 0.4640758862162355f, -0.5019277488755438f, },
			{ -0.2511439829004993f, 0.25904092914076043f, 0.33269347502456476f, -0.41579872047080496f, 0.8238741630728308f, },
			{ -0.7754135448053269f, 1.4707246848838271f, -0.6408925477510666f, -0.5053372597622974f, 0.8672917594411738f, },
			{ -0.383232842405566f, -1.3869393264613052f, 0.7546285885290532f, 2.887525425736014f, -0.5523200297665654f, },
			{ -0.4531891793616667f, -1.1501019193895916f, 0.07704990099995675f, 0.5125125260005895f, 2.4743718918928495f, }
		};

		var expected = new float[,]
		{
			{ 1.6459018855506056f, -1.9031435435608153f, -1.4319935618416773f, 0.4640758862162355f, -0.5019277488755438f, },
			{ 1.1471980272413398f, -1.3347388693011146f, -0.9680847820755422f, 0.23277053483775648f, -0.153395043452719f, },
			{ 0.37158746973086604f, -0.3342207324353382f, -0.5238002153108359f, -0.09782448383178158f, 0.32739018316592317f, },
			{ -0.30311471834691006f, -1.1279855763673918f, 0.5296284188685285f, 2.357109103482378f, -0.37794456579998975f, },
			{ 0.04899327080302709f, -0.7386603959147747f, -0.22590688249874905f, 1.015509078780587f, 0.21271554811002383f, }
		};

		var outputs = ArrayFactory.NewSameSize(q);

		LayerCausalSelfAttention.Forward(q, k, v, outputs);

		Assert.That(outputs, Is.EqualTo(expected).Within(1e-6f));
	}

}
